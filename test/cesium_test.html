<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Cesium 3D Globe Test</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-size: 16px;
            text-align: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        .controls button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .controls button:hover {
            background: #1976D2;
        }
        
        .status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="loading" class="loading">Loading Cesium Globe...</div>
    
    <div class="controls">
        <button onclick="resetView()">Reset View</button>
        <button onclick="zoomIn()">Zoom In</button>
        <button onclick="zoomOut()">Zoom Out</button>
        <button onclick="toggleRotation()">Toggle Rotation</button>
    </div>
    
    <div class="status" id="status">
        Status: Initializing...
    </div>
    
    <script>
        let cesiumViewer = null;
        let isRotating = true;
        
        // Set Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1NTA0MmZhZi0zNzc3LTRiNzItOGJiNS1hYzcxNzAyOTI0YTgiLCJpZCI6MzM4ODYwLCJpYXQiOjE3NTcxMTY5OTF9.CnDKHaxBmkJEXhz1lhhpui6rNmUZzF7ruXNfsPQIqtI';
        
        function updateStatus(message) {
            document.getElementById('status').textContent = 'Status: ' + message;
            console.log('Status:', message);
        }
        
        function hideLoading() {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
        
        function showError(message) {
            hideLoading();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `
                <h3>Error Loading 3D Globe</h3>
                <p>${message}</p>
                <button onclick="location.reload()">Retry</button>
            `;
            document.body.appendChild(errorDiv);
        }
        
        function initializeCesium() {
            try {
                updateStatus('Checking Cesium availability...');
                
                // Check if Cesium is available
                if (typeof Cesium === 'undefined') {
                    throw new Error('Cesium library not loaded');
                }
                
                updateStatus('Initializing Cesium viewer...');
                
                // Initialize Cesium viewer with optimized settings for memory
                cesiumViewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: Cesium.createWorldTerrain({
                        requestWaterMask: false,
                        requestVertexNormals: false
                    }),
                    timeline: false,
                    animation: false,
                    baseLayerPicker: false,
                    fullscreenButton: false,
                    vrButton: false,
                    geocoder: false,
                    homeButton: false,
                    infoBox: false,
                    sceneModePicker: false,
                    selectionIndicator: false,
                    navigationHelpButton: false,
                    navigationInstructionsInitiallyVisible: false,
                    scene3DOnly: true,
                    shouldAnimate: true,
                    // Memory optimization settings
                    contextOptions: {
                        requestWebgl2: false,
                        alpha: false,
                        depth: true,
                        stencil: false,
                        antialias: false,
                        premultipliedAlpha: true,
                        preserveDrawingBuffer: false,
                        failIfMajorPerformanceCaveat: false
                    }
                });

                updateStatus('Configuring camera...');

                // Configure camera
                cesiumViewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(0.0, 0.0, 20000000.0),
                    orientation: {
                        heading: 0.0,
                        pitch: Cesium.Math.toRadians(-90.0),
                        roll: 0.0
                    }
                });

                updateStatus('Loading Earth imagery...');

                // Add high-quality Earth imagery from Ion
                cesiumViewer.imageryLayers.removeAll();
                cesiumViewer.imageryLayers.addImageryProvider(
                    Cesium.IonImageryProvider.fromAssetId(1)
                );

                updateStatus('Configuring atmosphere...');

                // Add atmosphere
                cesiumViewer.scene.skyAtmosphere.show = true;
                cesiumViewer.scene.globe.enableLighting = true;
                cesiumViewer.scene.globe.dynamicAtmosphereLighting = true;
                cesiumViewer.scene.globe.atmosphereLightIntensity = 10.0;

                updateStatus('Setting up click handler...');

                // Add click handler for location changes
                cesiumViewer.cesiumWidget.screenSpaceEventHandler.setInputAction(
                    function onLeftClick(event) {
                        const pickedPosition = cesiumViewer.camera.pickEllipsoid(
                            event.position,
                            cesiumViewer.scene.globe.ellipsoid
                        );
                        
                        if (pickedPosition) {
                            const cartographic = Cesium.Cartographic.fromCartesian(pickedPosition);
                            const longitude = Cesium.Math.toDegrees(cartographic.longitude);
                            const latitude = Cesium.Math.toDegrees(cartographic.latitude);
                            
                            updateStatus(`Clicked: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        }
                    },
                    Cesium.ScreenSpaceEventType.LEFT_CLICK
                );

                updateStatus('Setting up auto-rotation...');

                // Auto-rotate the globe
                cesiumViewer.clock.onTick.addEventListener(function() {
                    if (isRotating) {
                        cesiumViewer.scene.camera.rotate(
                            Cesium.Cartesian3.UNIT_Z,
                            Cesium.Math.toRadians(0.1)
                        );
                    }
                });

                updateStatus('Globe ready!');
                hideLoading();
                
                console.log('Cesium globe initialized successfully!');

            } catch (error) {
                console.error('Cesium initialization error:', error);
                showError(error.toString());
            }
        }
        
        // Control functions
        function resetView() {
            if (cesiumViewer) {
                cesiumViewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(0.0, 0.0, 20000000.0),
                    orientation: {
                        heading: 0.0,
                        pitch: Cesium.Math.toRadians(-90.0),
                        roll: 0.0
                    }
                });
                updateStatus('View reset');
            }
        }
        
        function zoomIn() {
            if (cesiumViewer) {
                const camera = cesiumViewer.camera;
                camera.zoomIn(camera.positionCartographic.height * 0.5);
                updateStatus('Zoomed in');
            }
        }
        
        function zoomOut() {
            if (cesiumViewer) {
                const camera = cesiumViewer.camera;
                camera.zoomOut(camera.positionCartographic.height * 0.5);
                updateStatus('Zoomed out');
            }
        }
        
        function toggleRotation() {
            isRotating = !isRotating;
            updateStatus(isRotating ? 'Rotation enabled' : 'Rotation disabled');
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            updateStatus('Page loaded, starting Cesium...');
            setTimeout(function() {
                try {
                    initializeCesium();
                } catch (error) {
                    console.error('Error during initialization:', error);
                    showError(error.toString());
                }
            }, 1000);
        });
        
        // Error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e);
            showError('JavaScript error: ' + e.message);
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e);
            showError('Promise rejection: ' + (e.reason || 'Unknown error'));
        });
    </script>
</body>
</html>


